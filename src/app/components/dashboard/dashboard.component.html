<app-layout>
  <!-- Dashboard Content -->
  <div class="min-h-screen bg-gray-50">
    <!-- Breadcrumb -->
    <div class="px-6 py-4">
      <div class="flex items-center text-sm">
        <span class="text-gray-600">Home</span>
        <span class="mx-2 text-gray-500">></span>
        <span class="text-gray-800">Dashboard</span>
      </div>
    </div>

    <!-- Main Content -->
    <div class="px-6">
      <!-- Filter Section -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Branch Selection -->
        <div>
          <nz-select class="w-full" [(ngModel)]="selectedBranch" nzPlaceHolder="Chi nhánh" [nzLoading]="isLoadingBranches">
            <nz-option nzValue="all" nzLabel="Tất cả chi nhánh"></nz-option>
            <nz-option *ngFor="let branch of branches; trackBy: trackBranch" 
                       [nzValue]="getBranchValue(branch)" 
                       [nzLabel]="getBranchLabel(branch)"></nz-option>
            <nz-option *ngIf="!isLoadingBranches && branches.length === 0" nzValue="" nzLabel="Không có chi nhánh" nzDisabled="true"></nz-option>
          </nz-select>
        </div>

        <!-- Start Date -->
        <div>
          <nz-date-picker 
            class="w-full" 
            [(ngModel)]="startDate"
            nzPlaceHolder="Ngày bắt đầu"
            [nzSuffixIcon]="calendarIcon">
          </nz-date-picker>
          <ng-template #calendarIcon>
            <i nz-icon nzType="calendar" nzTheme="outline"></i>
          </ng-template>
        </div>

        <!-- End Date -->
        <div>
          <nz-date-picker 
            class="w-full" 
            [(ngModel)]="endDate"
            nzPlaceHolder="Ngày kết thúc"
            [nzSuffixIcon]="calendarIcon">
          </nz-date-picker>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-4 mb-6">
        <!-- Refresh Button -->
        <button (click)="refresh()" class="flex items-center px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50">
          <i nz-icon nzType="sync" class="mr-2"></i>
          Làm mới
        </button>

        <!-- Export Button -->
        <div class="relative">
          <button nz-button nz-dropdown [nzDropdownMenu]="menu" class="bg-yellow-500 text-white px-4 py-2 rounded flex items-center">
            <i nz-icon nzType="download" class="mr-2"></i>
            Xuất báo cáo
            <i nz-icon nzType="down" class="ml-2"></i>
          </button>
          <nz-dropdown-menu #menu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>Excel</li>
              <li nz-menu-item>PDF</li>
            </ul>
          </nz-dropdown-menu>
        </div>

        <!-- Table View Toggle -->
        <button (click)="toggleView()" class="flex items-center px-4 py-2 rounded transition-colors duration-200"
                [class.bg-pink-500]="isTableView"
                [class.bg-gray-500]="!isTableView"
                [class.text-white]="true">
          <i nz-icon [nzType]="isTableView ? 'pie-chart' : 'table'" class="mr-2"></i>
          {{isTableView ? 'Dashboard View' : 'Table View'}}
        </button>
      </div>

      <!-- Dashboard View (Chart Section) -->
      <div *ngIf="!isTableView" class="bg-white rounded-lg p-6">
        <h2 class="text-lg font-medium mb-6">
          Biểu đồ tổng hợp trạng thái đóng/mở kho : {{endDate | date:'dd-MM-yyyy'}}
        </h2>
        
        <!-- Chart Container -->
        <div class="flex items-center justify-center py-8">
          <div class="text-center">
            <!-- Pie Chart -->
            <div class="mb-8">
              <div class="w-[200px] h-[200px] mx-auto bg-yellow-500 rounded-full relative">
                <div class="absolute inset-0 flex items-center justify-center text-white text-4xl font-bold">
                  100.0%
                </div>
              </div>
            </div>
            
            <!-- Legend -->
            <div class="flex items-center justify-center gap-8">
              <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                <span class="text-gray-600">Số lượng kho mở: 0</span>
              </div>
              <div class="flex items-center">
                <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                <span class="text-gray-600">Số lượng kho đóng: 1</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Line Chart Section -->
        <div class="mt-8 bg-white rounded-lg p-6">
          <h2 class="text-lg font-medium mb-6">
            Biểu đồ tổng hợp số lượt vi phạm cập nhật: {{endDate | date:'dd-MM-yyyy'}}
          </h2>
          
          <!-- Loading State -->
          <div *ngIf="isLoadingChart" class="flex justify-center items-center h-[300px]">
            <nz-spin nzTip="Đang tải dữ liệu..."></nz-spin>
          </div>

          <!-- Chart Container -->
          <div *ngIf="!isLoadingChart" class="relative h-[300px] w-full">
            <!-- Y-axis labels -->
            <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-sm text-gray-600 py-4">
              <span>5</span>
              <span>4</span>
              <span>3</span>
              <span>2</span>
              <span>1</span>
              <span>0</span>
            </div>
            
            <!-- Chart Area -->
            <div class="ml-8 h-full relative">
              <!-- Grid lines -->
              <div class="absolute inset-0 flex flex-col justify-between">
                <div *ngFor="let _ of [0,1,2,3,4,5]" class="border-b border-gray-200 h-[16.666%]"></div>
              </div>
              
              <!-- Data points and line -->
              <div class="absolute inset-0">
                <svg class="w-full h-full">
                  <!-- Line connecting points -->
                  <path [attr.d]="getChartPath()"
                    class="stroke-blue-500 stroke-2 fill-none"/>
                  
                  <!-- Data points -->
                  <g *ngFor="let point of chartData; let i = index">
                    <circle [attr.cx]="getPointX(i)"
                            [attr.cy]="getPointY(point.value)"
                            r="4"
                            class="fill-blue-500"/>
                  </g>
                </svg>
              </div>
              
              <!-- X-axis labels -->
              <div class="absolute bottom-[-2.5rem] left-0 right-0 flex justify-between text-sm text-gray-600">
                <div *ngFor="let point of chartData" class="transform -rotate-45 origin-top-left">
                  {{point.date}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div *ngIf="isTableView" class="bg-white rounded-lg p-6">
        <h2 class="text-lg font-medium mb-6">
          Bảng tổng hợp trạng thái đóng/mở kho : {{endDate | date:'dd-MM-yyyy'}}
        </h2>
        
        <!-- Table Container -->
        <nz-table #basicTable [nzData]="tableData" [nzPageSize]="10">
          <thead>
            <tr>
              <th>STT</th>
              <th>Tên kho</th>
              <th>Trạng thái</th>
              <th>Thời gian</th>
              <th>Người thực hiện</th>
              <th>Ghi chú</th>
            </tr>
          </thead>
          <tbody>
            <tr *nzFor="let data of basicTable.data; index as i">
              <td>{{ i + 1 }}</td>
              <td>{{ data.tenKho }}</td>
              <td>
                <nz-tag [nzColor]="data.trangThai === 'Mở' ? 'green' : 'orange'">
                  {{ data.trangThai }}
                </nz-tag>
              </td>
              <td>{{ data.thoiGian | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ data.nguoiThucHien }}</td>
              <td>{{ data.ghiChu }}</td>
            </tr>
          </tbody>
        </nz-table>
      </div>
    </div>
  </div>
</app-layout> 